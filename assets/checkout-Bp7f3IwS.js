import{g as S,c as k,i as w,a as z,r as T}from"../js/app.js";function V(r){const a=document.getElementById("summary-items-list"),p=document.getElementById("summary-subtotal"),y=document.getElementById("summary-total");if(!a||!p||!y)return;if(!r||r.length===0){a.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}a.innerHTML="";const o={};r.forEach(e=>{const l=document.createElement("div");l.className="flex justify-between text-sm",l.innerHTML=`<div><span class="font-semibold">${e.quantity} x</span> ${e.title}</div><span>${(e.price.amount*e.quantity).toFixed(2)} ${e.price.currency}</span>`,a.appendChild(l);const t=e.price.currency;o[t]||(o[t]=0),o[t]+=e.price.amount*e.quantity}),p.innerHTML="",y.innerHTML="",Object.entries(o).forEach(([e,l])=>{const t=`${Number(l).toFixed(2)} ${e}`;p.innerHTML+=`<div>${t}</div>`,y.innerHTML+=`<div>${t}</div>`})}function D(){const r=document.getElementById("checkout-form");if(!r)return;const a=S()||[];V(a);const p=document.getElementById("step-address"),y=document.getElementById("step-payment"),o=document.getElementById("continue-to-payment-btn"),e=document.getElementById("progress-bar"),l=document.getElementById("checkout-title"),t=document.getElementById("submit-order-btn"),f=document.getElementById("payment-methods"),E=document.getElementById("selected-payment-method"),B=document.getElementById("payment-instructions"),n=document.getElementById("checkout-error");document.getElementById("use-geolocation-btn");let v=null;const I=async()=>{var h,d;n.classList.add("hidden");const u=r.elements.name.value.trim(),s=r.elements.phone.value.trim(),i=r.elements.address.value.trim();if(!u||!s||!i){n.textContent="Veuillez remplir tous les champs de livraison requis.",n.classList.remove("hidden");return}o.disabled=!0,o.textContent="Enregistrement...";try{const c=JSON.parse(((h=document.querySelector(".zflex-fragment-data"))==null?void 0:h.textContent)||"{}").storeId;if(!c)throw new Error("ID du store manquant. La navigation a peut-être été trop rapide. Veuillez réessayer.");const q={name:u,phone:s,address:i,notes:r.elements.notes.value.trim()},M=a.reduce((P,C)=>P+C.price.amount*C.quantity,0),x={customer:q,items:a,total:M,currency:((d=a[0])==null?void 0:d.price.currency)||"EUR"};console.log("Payload pour createOrder:",x);const g=await k(x,c);if(!g.success||!g.orderId)throw new Error(g.error||"La création de la pré-commande a échoué.");v=g.orderId,localStorage.setItem("zflex_prospectId",g.prospectId),p.classList.add("hidden"),y.classList.remove("hidden"),e.style.width="60%",l.textContent="Étape 2: Paiement"}catch(m){n.textContent=m.message||"Une erreur est survenue.",n.classList.remove("hidden"),o.disabled=!1,o.textContent="Continuer vers le paiement"}},L=u=>{const s=u.target.closest(".payment-method-btn");s&&(document.querySelectorAll(".payment-method-btn").forEach(i=>i.classList.remove("border-primary","ring-2","ring-offset-2")),s.classList.add("border-primary","ring-2","ring-offset-2"),E.value=s.dataset.method,B.innerHTML=`<p>Vous avez choisi <strong>${s.dataset.method}</strong>. Vous recevrez une notification sur le numéro de téléphone fourni pour valider la transaction.</p>`)},b=async u=>{var h;if(u.preventDefault(),n.classList.add("hidden"),!v){n.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",n.classList.remove("hidden");return}const s=E.value,i=r.elements.payment_phone.value;if(!s||!i||i.length<9){n.textContent="Veuillez choisir une méthode et entrer un numéro de paiement valide.",n.classList.remove("hidden");return}t.disabled=!0,t.querySelector(".btn-text").textContent="Veuillez valider sur votre téléphone...",t.querySelector(".btn-spinner").classList.remove("hidden");try{const m=JSON.parse(((h=document.querySelector(".zflex-fragment-data"))==null?void 0:h.textContent)||"{}").storeId;if(!m)throw new Error("ID du store manquant. La navigation a peut-être été trop rapide. Veuillez réessayer.");const c={orderId:v,storeId:m,paymentMethod:s,paymentPhone:i};console.log("Payload pour initiatePayment:",c),await w(c.orderId,c.storeId,c.paymentMethod,c.paymentPhone),e.style.width="90%",t.querySelector(".btn-text").textContent="Paiement initié ! Redirection...",setTimeout(()=>{z(),T.navigateTo(`/order-success/?id=${encodeURIComponent(v)}`)},4e3)}catch(d){console.error("[Checkout] Erreur lors de l'initiation du paiement:",d);try{const m=JSON.parse(d.message.substring(d.message.indexOf("{")));n.textContent="Erreur de validation. Veuillez vérifier vos informations."}catch{n.textContent=d.message||"Le lancement du paiement a échoué."}n.classList.remove("hidden"),e.style.width="60%",t.disabled=!1,t.querySelector(".btn-text").textContent="Confirmer et Payer",t.querySelector(".btn-spinner").classList.add("hidden")}};return o.addEventListener("click",I),f.addEventListener("click",L),r.addEventListener("submit",b),console.log("[Checkout] Module V6.0 (La Refondation) initialisé."),{destroy:()=>{o.removeEventListener("click",I),f.removeEventListener("click",L),r.removeEventListener("submit",b),console.log("[Checkout] Module détruit.")}}}export{D as initCheckout};
