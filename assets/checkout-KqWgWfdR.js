import{g as M,c as q,i as k,a as T,r as w}from"../js/app.js";function $(n){const a=document.getElementById("summary-items-list"),m=document.getElementById("summary-subtotal"),u=document.getElementById("summary-total");if(!a||!m||!u)return;if(!n||n.length===0){a.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}a.innerHTML="";const o={};n.forEach(e=>{const d=document.createElement("div");d.className="flex justify-between text-sm",d.innerHTML=`<div><span class="font-semibold">${e.quantity} x</span> ${e.title}</div><span>${(e.price.amount*e.quantity).toFixed(2)} ${e.price.currency}</span>`,a.appendChild(d);const t=e.price.currency;o[t]||(o[t]=0),o[t]+=e.price.amount*e.quantity}),m.innerHTML="",u.innerHTML="",Object.entries(o).forEach(([e,d])=>{const t=`${Number(d).toFixed(2)} ${e}`;m.innerHTML+=`<div>${t}</div>`,u.innerHTML+=`<div>${t}</div>`})}function z(){const n=document.getElementById("checkout-form");if(!n)return;const a=M()||[];$(a);const m=document.getElementById("step-address"),u=document.getElementById("step-payment"),o=document.getElementById("continue-to-payment-btn"),e=document.getElementById("progress-bar"),d=document.getElementById("checkout-title"),t=document.getElementById("submit-order-btn"),v=document.getElementById("payment-methods"),f=document.getElementById("selected-payment-method"),x=document.getElementById("payment-instructions"),s=document.getElementById("checkout-error");let p=null;const E=async()=>{var i,c;if(s.classList.add("hidden"),!n.elements.name.value||!n.elements.phone.value||!n.elements.address.value){s.textContent="Veuillez remplir tous les champs de livraison.",s.classList.remove("hidden");return}o.disabled=!0,o.textContent="Enregistrement...";try{const r=new FormData(n),l={name:String(r.get("name")||""),phone:String(r.get("phone")||""),address:String(r.get("address")||""),notes:String(r.get("notes")||"")},y=JSON.parse(((i=document.querySelector(".zflex-fragment-data"))==null?void 0:i.textContent)||"{}").storeId;if(!y)throw new Error("ID du store manquant.");const C=a.reduce((S,L)=>S+L.price.amount*L.quantity,0),B={customer:l,items:a,total:C,currency:((c=a[0])==null?void 0:c.price.currency)||"EUR"},h=await q(B,y);if(!h.success||!h.orderId)throw new Error("La création de la pré-commande a échoué.");p=h.orderId,localStorage.setItem("zflex_prospectId",h.prospectId),m.classList.add("hidden"),u.classList.remove("hidden"),e.style.width="60%",d.textContent="Étape 2: Paiement"}catch(r){s.textContent=r.message||"Une erreur est survenue.",s.classList.remove("hidden"),o.disabled=!1,o.textContent="Continuer vers le paiement"}},I=i=>{const c=i.target.closest(".payment-method-btn");if(!c)return;document.querySelectorAll(".payment-method-btn").forEach(l=>l.classList.remove("border-primary","ring-2","ring-offset-2")),c.classList.add("border-primary","ring-2","ring-offset-2");const r=c.dataset.method;f.value=r,x.innerHTML=`<p>Vous avez choisi <strong>${r}</strong>. Vous recevrez une notification sur le numéro de téléphone fourni pour valider la transaction.</p>`},b=async i=>{var l;if(i.preventDefault(),!p)return;s.classList.add("hidden");const c=f.value,r=n.elements.payment_phone.value;if(!c||!r){s.textContent="Veuillez choisir une méthode et entrer un numéro de téléphone pour le paiement.",s.classList.remove("hidden");return}e.style.width="90%",t.disabled=!0,t.querySelector(".btn-text").textContent="Veuillez valider sur votre téléphone...",t.querySelector(".btn-spinner").classList.remove("hidden");try{const y=JSON.parse(((l=document.querySelector(".zflex-fragment-data"))==null?void 0:l.textContent)||"{}").storeId;await k(p,y,c,r),t.querySelector(".btn-text").textContent="Paiement initié ! Redirection...",setTimeout(()=>{T(),w.navigateTo(`/order-success/?id=${encodeURIComponent(p)}`)},4e3)}catch(g){s.textContent=g.message||"Le lancement du paiement a échoué.",s.classList.remove("hidden"),e.style.width="60%",t.disabled=!1,t.querySelector(".btn-text").textContent="Confirmer et Payer",t.querySelector(".btn-spinner").classList.add("hidden")}};return o.addEventListener("click",E),v.addEventListener("click",I),n.addEventListener("submit",b),console.log("[Checkout] Module V4.0 (Chef d'Orchestre) initialisé."),{destroy:()=>{o.removeEventListener("click",E),v.removeEventListener("click",I),n.removeEventListener("submit",b),console.log("[Checkout] Module détruit.")}}}export{z as initCheckout};
