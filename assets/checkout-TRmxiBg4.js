import{g as O,a as z,e as V,c as F,i as H,b as R,r as D}from"../js/app.js";function q(){try{const t=document.getElementById("zflex-data")||document.querySelector(".zflex-fragment-data");return!t||!t.textContent?(console.warn("[Checkout] Tunnel de data est vide ou introuvable."),{}):JSON.parse(t.textContent)}catch(t){return console.error("[Checkout] Erreur de parsing du tunnel de data:",t),{}}}function M(t){if(!t)return{operator:null,logoFileName:null};let e=String(t).trim();e=e.replace(/\D/g,""),e.startsWith("243")&&(e=e.slice(3)),e.startsWith("0")&&(e=e.slice(1));const i=e.substring(0,2),f=["81","82","83"],u=["80","84","85","89"],o=["97","99"],p=["90"];return f.includes(i)?{operator:"MPESA",logoFileName:"mpesa"}:u.includes(i)?{operator:"ORANGE",logoFileName:"orangemoney"}:o.includes(i)?{operator:"AIRTEL",logoFileName:"airtelmoney"}:p.includes(i)?{operator:"AFRICELL",logoFileName:"africell"}:{operator:null,logoFileName:null}}function U(t){const e=document.getElementById("summary-items-list"),i=document.getElementById("summary-subtotal"),f=document.getElementById("summary-total");if(!e||!i||!f)return;if(!t||t.length===0){e.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>',i.innerHTML="",f.innerHTML="";return}e.innerHTML="";const u={};t.forEach(o=>{const p=document.createElement("div");p.className="flex justify-between text-sm",p.innerHTML=`<div><span class="font-semibold">${o.quantity} x</span> ${o.title}</div><span>${(o.price.amount*o.quantity).toFixed(2)} ${o.price.currency}</span>`,e.appendChild(p);const v=o.price.currency;u[v]||(u[v]=0),u[v]+=o.price.amount*o.quantity}),i.innerHTML="",f.innerHTML="",Object.entries(u).forEach(([o,p])=>{const v=`${Number(p).toFixed(2)} ${o}`;i.innerHTML+=`<div>${v}</div>`,f.innerHTML+=`<div>${v}</div>`})}function j(){const t=document.getElementById("checkout-form");if(!t)return;const e=document.getElementById("checkout-error");let i=null;const f=async l=>{const r=localStorage.getItem("zflex_prospectId");if(!(!r||!l))try{const n=await z(l,r);if(n.success&&n.data){const{operator:c,logoFileName:d}=M(n.data.phone),a=c?`<div class="mt-2"><img src="/img/${d}.png" alt="${c}" style="height:28px;display:inline-block;margin-right:8px;vertical-align:middle" /> <span style="vertical-align:middle">Opérateur probable: <strong>${c}</strong></span></div>`:"";V.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"On vous reconnaît !",message:"Voulez-vous utiliser les informations de votre dernière visite ?",messageHtml:`
                <div class="flex items-start gap-3">
                  <div style="flex:0 0 auto">
                    <div style="width:56px;height:56px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:600;color:#111">${(n.data.name||"U").charAt(0)}</div>
                  </div>
                  <div style="flex:1">
                    <div style="margin-bottom:6px">Nom: <strong>${n.data.name||""}</strong></div>
                    <div style="margin-bottom:6px">Tel: <strong>${n.data.phone||""}</strong></div>
                    <div style="margin-bottom:6px">Adresse: <small style="color:#6b7280">${n.data.address||""}</small></div>
                    ${a}
                  </div>
                </div>
              `,confirmText:"Oui, utiliser",cancelText:"Non, merci",variant:"info",onConfirm:()=>{t.elements.name&&(t.elements.name.value=n.data.name||""),t.elements.email&&(t.elements.email.value=n.data.email||""),t.elements.phone&&(t.elements.phone.value=n.data.phone||""),t.elements.address&&(t.elements.address.value=n.data.address||""),t.elements.notes&&(t.elements.notes.value=n.data.notes||"")},onCancel:()=>{}}}))}}catch(n){console.warn("Impossible de récupérer les infos du prospect/client:",n.message||n),String(n.message||"").includes("Aucune information")&&localStorage.removeItem("zflex_prospectId")}},u=q().storeId;if(!u){console.error("[Checkout] Erreur critique : ID du store non trouvé à l'initialisation.");const l=document.querySelector(".lg\\:col-span-3");l&&(l.innerHTML='<div class="text-red-500 p-4 border border-red-200 rounded-lg bg-red-50"><strong>Erreur de chargement.</strong> Impossible de récupérer les informations de la boutique. Veuillez rafraîchir la page.</div>');return}f(u);const o=O()||[];U(o);const p=document.getElementById("step-address"),v=document.getElementById("step-payment"),y=document.getElementById("continue-to-payment-btn"),I=document.getElementById("progress-bar"),$=document.getElementById("checkout-title"),s=document.getElementById("submit-order-btn"),E=document.getElementById("payment-phone"),L=document.getElementById("operator-logo-container"),x=document.getElementById("selected-payment-method"),b=document.getElementById("payment-instructions"),m=document.getElementById("use-geolocation-btn"),A=document.getElementById("address");if(document.getElementById("notes"),!y||!s){console.error("[Checkout] Boutons manquants.");return}const C=()=>{const l=(E.value||"").replace(/\s/g,""),{operator:r,logoFileName:n}=M(l);r?(x.value=r,b.innerHTML=`<p>Opérateur <strong>${r}</strong> détecté. Vous recevrez une notification pour valider.</p>`):(x.value="",b.innerHTML="<p>Veuillez entrer un numéro valide pour détecter l'opérateur.</p>"),L&&(L.innerHTML="")},S=()=>{if(!navigator.geolocation){e.textContent="La géolocalisation n'est pas supportée par votre navigateur.",e.classList.remove("hidden");return}m.disabled=!0,m.classList.add("animate-pulse");const l={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async r=>{const{latitude:n,longitude:c}=r.coords;try{const a=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${n}&lon=${c}`)).json();if(a&&a.display_name)A.value=a.display_name;else throw new Error("Adresse non trouvée.")}catch{e.textContent="Impossible de convertir les coordonnées en adresse.",e.classList.remove("hidden")}finally{m.disabled=!1,m.classList.remove("animate-pulse")}},r=>{let n="Erreur de géolocalisation.";r.code===r.PERMISSION_DENIED&&(n="Vous avez refusé la permission d'accès à la localisation."),r.code===r.POSITION_UNAVAILABLE&&(n="Votre position n'est pas disponible."),r.code===r.TIMEOUT&&(n="Le service de localisation a mis trop de temps à répondre."),e.textContent=n,e.classList.remove("hidden"),m.disabled=!1,m.classList.remove("animate-pulse")},l)},w=async()=>{var d,a;e.classList.add("hidden");const l=t.elements.name.value.trim(),r=t.elements.email.value.trim(),n=t.elements.phone.value.trim(),c=t.elements.address.value.trim();if(!l||!r||!n||!c){e.textContent="Veuillez remplir tous les champs requis.",e.classList.remove("hidden");return}y.disabled=!0,y.textContent="Enregistrement...";try{const g={name:l,email:r,phone:n,address:c,notes:((d=t.elements.notes)==null?void 0:d.value.trim())||""},N=o.reduce((k,B)=>k+B.price.amount*B.quantity,0),P={customer:g,items:o,total:N,currency:((a=o[0])==null?void 0:a.price.currency)||"EUR"},h=await F(P,u);if(!h.success||!h.orderId)throw new Error(h.error||"La création de la pré-commande a échoué.");i=h.orderId,h.prospectId&&localStorage.setItem("zflex_prospectId",h.prospectId),p.classList.add("hidden"),v.classList.remove("hidden"),I.style.width="60%",$.textContent="Étape 2: Paiement"}catch(g){e.textContent=g.message||"Une erreur est survenue.",e.classList.remove("hidden"),y.disabled=!1,y.textContent="Continuer vers le paiement"}},T=async l=>{if(l.preventDefault(),e.classList.add("hidden"),!i){e.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",e.classList.remove("hidden");return}const r=x.value,c=(E.value||"").replace(/\D/g,"");if(!r||!c||c.length<9){e.textContent="Veuillez entrer un numéro de paiement valide pour détecter l'opérateur.",e.classList.remove("hidden");return}s.disabled=!0,s.querySelector(".btn-text").textContent="Initiation du paiement...",s.querySelector(".btn-spinner").classList.remove("hidden");try{const d=q().storeId;if(!d)throw new Error("Erreur de configuration : ID du store manquant. Veuillez rafraîchir la page.");const a=await H(i,d,r,`+243${c}`);if(a.transactionStatus==="PENDING")I.style.width="95%",s.querySelector(".btn-text").textContent="Veuillez confirmer sur votre téléphone...",setTimeout(()=>{s&&(s.querySelector(".btn-spinner").classList.add("hidden"),s.disabled=!1,s.querySelector(".btn-text").textContent="Réessayer / Actualiser")},3e4);else if(a.transactionStatus==="SUCCESS")I.style.width="100%",s.querySelector(".btn-text").textContent="Paiement réussi ! Redirection...",s.querySelector(".btn-spinner").classList.add("hidden"),setTimeout(()=>{R();try{D.navigateTo(`/order-success/?id=${encodeURIComponent(i)}`)}catch{window.location.href=`/order-success/?id=${encodeURIComponent(i)}`}},1e3);else throw s.querySelector(".btn-spinner").classList.add("hidden"),s.disabled=!1,s.querySelector(".btn-text").textContent="Confirmer et Payer",new Error("Statut de transaction inattendu.")}catch(d){const a=d.message||String(d);let g="Le lancement du paiement a échoué.";a.includes("transactionReference already exists")?g="Cette commande a déjà une tentative de paiement. Veuillez rafraîchir la page.":a.toLowerCase().includes("aucun opérateur")||a.toLowerCase().includes("operator")?g="L'opérateur pour ce numéro n'est pas supporté. Veuillez vérifier le numéro.":g=a,e.textContent=g,e.classList.remove("hidden"),s.querySelector(".btn-spinner").classList.add("hidden"),s.disabled=!1,s.querySelector(".btn-text").textContent="Confirmer et Payer"}};return y.addEventListener("click",w),E.addEventListener("input",C),m&&m.addEventListener("click",S),t.addEventListener("submit",T),console.log("[Checkout] Module V12.1 initialisé."),{destroy:()=>{y.removeEventListener("click",w),E.removeEventListener("input",C),m&&m.removeEventListener("click",S),t.removeEventListener("submit",T),console.log("[Checkout] Module détruit.")}}}export{j as initCheckout};
