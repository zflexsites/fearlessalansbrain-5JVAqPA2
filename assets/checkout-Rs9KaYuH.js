import{g as M,c as T,i as $,a as P,r as V}from"../js/app.js";function z(r){const d=document.getElementById("summary-items-list"),p=document.getElementById("summary-subtotal"),y=document.getElementById("summary-total");if(!d||!p||!y)return;if(!r||r.length===0){d.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}d.innerHTML="";const s={};r.forEach(n=>{const u=document.createElement("div");u.className="flex justify-between text-sm",u.innerHTML=`<div><span class="font-semibold">${n.quantity} x</span> ${n.title}</div><span>${(n.price.amount*n.quantity).toFixed(2)} ${n.price.currency}</span>`,d.appendChild(u);const o=n.price.currency;s[o]||(s[o]=0),s[o]+=n.price.amount*n.quantity}),p.innerHTML="",y.innerHTML="",Object.entries(s).forEach(([n,u])=>{const o=`${Number(u).toFixed(2)} ${n}`;p.innerHTML+=`<div>${o}</div>`,y.innerHTML+=`<div>${o}</div>`})}function H(){const r=document.getElementById("checkout-form");if(!r)return;const d=M()||[];z(d);const p=document.getElementById("step-address"),y=document.getElementById("step-payment"),s=document.getElementById("continue-to-payment-btn"),n=document.getElementById("progress-bar"),u=document.getElementById("checkout-title"),o=document.getElementById("submit-order-btn"),f=document.getElementById("payment-methods"),E=document.getElementById("selected-payment-method"),B=document.getElementById("payment-instructions"),e=document.getElementById("checkout-error"),c=document.getElementById("use-geolocation-btn"),S=document.getElementById("address");let h=null;const L=async()=>{if(!navigator.geolocation){e.textContent="La géolocalisation n'est pas supportée par votre navigateur.",e.classList.remove("hidden");return}c.disabled=!0,c.querySelector("span").textContent="Récupération...",navigator.geolocation.getCurrentPosition(async i=>{const{latitude:a,longitude:t}=i.coords;try{const m=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${a}&lon=${t}`)).json();if(m&&m.display_name)S.value=m.display_name,e.classList.add("hidden");else throw new Error("Adresse non trouvée.")}catch{e.textContent="Impossible de convertir les coordonnées en adresse.",e.classList.remove("hidden")}finally{c.disabled=!1,c.querySelector("span").textContent="Utiliser ma position actuelle"}},i=>{e.textContent=`Erreur de géolocalisation : ${i.message}`,e.classList.remove("hidden"),c.disabled=!1,c.querySelector("span").textContent="Utiliser ma position actuelle"})},x=async()=>{var i,a;if(e.classList.add("hidden"),!r.checkValidity()){e.textContent="Veuillez remplir tous les champs de livraison requis.",e.classList.remove("hidden"),r.reportValidity();return}s.disabled=!0,s.textContent="Enregistrement...";try{const t=new FormData(r),l={name:String(t.get("name")||""),phone:String(t.get("phone")||""),address:String(t.get("address")||""),notes:String(t.get("notes")||"")},g=JSON.parse(((i=document.querySelector(".zflex-fragment-data"))==null?void 0:i.textContent)||"{}").storeId;if(!g)throw new Error("ID du store manquant.");const q=d.reduce((w,I)=>w+I.price.amount*I.quantity,0),k={customer:l,items:d,total:q,currency:((a=d[0])==null?void 0:a.price.currency)||"EUR"},v=await T(k,g);if(!v.success||!v.orderId)throw new Error("La création de la pré-commande a échoué.");h=v.orderId,localStorage.setItem("zflex_prospectId",v.prospectId),p.classList.add("hidden"),y.classList.remove("hidden"),n.style.width="60%",u.textContent="Étape 2: Paiement"}catch(t){e.textContent=t.message||"Une erreur est survenue.",e.classList.remove("hidden"),s.disabled=!1,s.textContent="Continuer vers le paiement"}},b=i=>{const a=i.target.closest(".payment-method-btn");if(!a)return;document.querySelectorAll(".payment-method-btn").forEach(l=>l.classList.remove("border-primary","ring-2","ring-offset-2")),a.classList.add("border-primary","ring-2","ring-offset-2");const t=a.dataset.method;E.value=t,B.innerHTML=`<p>Vous avez choisi <strong>${t}</strong>. Vous recevrez une notification sur le numéro de téléphone fourni pour valider la transaction.</p>`},C=async i=>{var l;if(i.preventDefault(),!h)return;e.classList.add("hidden");const a=E.value,t=r.elements.payment_phone.value;if(!a){e.textContent="Veuillez choisir une méthode de paiement.",e.classList.remove("hidden");return}if(!t||t.length<9){e.textContent="Veuillez entrer un numéro de téléphone de paiement valide.",e.classList.remove("hidden");return}n.style.width="90%",o.disabled=!0,o.querySelector(".btn-text").textContent="Veuillez valider sur votre téléphone...",o.querySelector(".btn-spinner").classList.remove("hidden");try{const g=JSON.parse(((l=document.querySelector(".zflex-fragment-data"))==null?void 0:l.textContent)||"{}").storeId;await $(h,g,a,t),o.querySelector(".btn-text").textContent="Paiement initié ! Redirection...",setTimeout(()=>{P(),V.navigateTo(`/order-success/?id=${encodeURIComponent(h)}`)},4e3)}catch(m){e.textContent=m.message||"Le lancement du paiement a échoué.",e.classList.remove("hidden"),n.style.width="60%",o.disabled=!1,o.querySelector(".btn-text").textContent="Confirmer et Payer",o.querySelector(".btn-spinner").classList.add("hidden")}};return s.addEventListener("click",x),f.addEventListener("click",b),c.addEventListener("click",L),r.addEventListener("submit",C),console.log("[Checkout] Module V4.2 (Géoloc & Blindé) initialisé."),{destroy:()=>{s.removeEventListener("click",x),f.removeEventListener("click",b),c.removeEventListener("click",L),r.removeEventListener("submit",C),console.log("[Checkout] Module détruit.")}}}export{H as initCheckout};
