import{g as O,a as V,e as P,c as k,i as N,b as $,r as R}from"../js/app.js";function x(){try{const t=document.getElementById("zflex-data")||document.querySelector(".zflex-fragment-data");return!t||!t.textContent?(console.warn("[Checkout] Tunnel de data est vide ou introuvable."),{}):JSON.parse(t.textContent)}catch(t){return console.error("[Checkout] Erreur de parsing du tunnel de data:",t),{}}}function H(t){const n=document.getElementById("summary-items-list"),v=document.getElementById("summary-subtotal"),g=document.getElementById("summary-total");if(!n||!v||!g)return;if(!t||t.length===0){n.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}n.innerHTML="";const l={};t.forEach(o=>{const d=document.createElement("div");d.className="flex justify-between text-sm",d.innerHTML=`<div><span class="font-semibold">${o.quantity} x</span> ${o.title}</div><span>${(o.price.amount*o.quantity).toFixed(2)} ${o.price.currency}</span>`,n.appendChild(d);const u=o.price.currency;l[u]||(l[u]=0),l[u]+=o.price.amount*o.quantity}),v.innerHTML="",g.innerHTML="",Object.entries(l).forEach(([o,d])=>{const u=`${Number(d).toFixed(2)} ${o}`;v.innerHTML+=`<div>${u}</div>`,g.innerHTML+=`<div>${u}</div>`})}function F(){const t=document.getElementById("checkout-form");if(!t)return;const n=document.getElementById("checkout-error"),v=async a=>{const r=localStorage.getItem("zflex_prospectId");if(!(!r||!a))try{const e=await V({storeId:a,prospectId:r});e.success&&e.data&&P.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"On vous reconnaît !",message:"Voulez-vous utiliser les informations de votre dernière visite ?",confirmText:"Oui, utiliser",cancelText:"Non, merci",onConfirm:()=>{t.elements.name.value=e.data.name||"",t.elements.email.value=e.data.email||"",t.elements.phone.value=e.data.phone||"",t.elements.address.value=e.data.address||""}}}))}catch(e){console.warn("Impossible de récupérer les infos du prospect/client:",e.message),e.message.includes("Aucune information")&&localStorage.removeItem("zflex_prospectId")}},g=x().storeId;if(!g){console.error("[Checkout] Erreur critique : ID du store non trouvé à l'initialisation.");const a=document.querySelector(".lg\\:col-span-3");a&&(a.innerHTML='<div class="text-red-500 p-4 border border-red-200 rounded-lg bg-red-50"><strong>Erreur de chargement.</strong> Impossible de récupérer les informations de la boutique. Veuillez rafraîchir la page.</div>');return}v(g);const l=O()||[];H(l);const o=document.getElementById("continue-to-payment-btn"),d=document.getElementById("progress-bar"),u=document.getElementById("checkout-title"),m=document.getElementById("submit-order-btn"),y=document.getElementById("payment-phone"),b=document.getElementById("operator-logo-container"),I=document.getElementById("selected-payment-method"),S=document.getElementById("payment-instructions"),p=document.getElementById("use-geolocation-btn"),q=document.getElementById("address");let E=null;const T=()=>{const r=y.value.replace(/\s/g,"").substring(0,2);let e=null;const i=["81","82","83"],s=["80","84","85","89"],c=["97","99"],L=["90"];if(i.includes(r)&&(e="MPESA"),s.includes(r)&&(e="ORANGE"),c.includes(r)&&(e="AIRTEL"),L.includes(r)&&(e="AFRICELL"),b.innerHTML="",e){const f=document.createElement("img"),C=e==="ORANGE"?"orangemoney":e==="AIRTEL"?"airtelmoney":e.toLowerCase();f.src=`/img/${C}.png`,f.className="h-6",b.appendChild(f),I.value=e,S.innerHTML=`<p>Opérateur <strong>${e}</strong> détecté. Vous recevrez une notification pour valider.</p>`}else I.value="",S.innerHTML="<p>Veuillez entrer un numéro valide pour détecter l'opérateur.</p>"},w=()=>{if(!navigator.geolocation){n.textContent="La géolocalisation n'est pas supportée par votre navigateur.",n.classList.remove("hidden");return}p.disabled=!0,p.classList.add("animate-pulse");const a={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async r=>{const{latitude:e,longitude:i}=r.coords;try{const c=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${i}`)).json();if(c&&c.display_name)q.value=c.display_name;else throw new Error("Adresse non trouvée.")}catch{n.textContent="Impossible de convertir les coordonnées en adresse.",n.classList.remove("hidden")}finally{p.disabled=!1,p.classList.remove("animate-pulse")}},r=>{let e="Erreur de géolocalisation.";r.code===r.PERMISSION_DENIED&&(e="Vous avez refusé la permission d'accès à la localisation."),r.code===r.POSITION_UNAVAILABLE&&(e="Votre position n'est pas disponible."),r.code===r.TIMEOUT&&(e="Le service de localisation a mis trop de temps à répondre."),n.textContent=e,n.classList.remove("hidden"),p.disabled=!1,p.classList.remove("animate-pulse")},a)},B=async()=>{var s;n.classList.add("hidden");const a=t.elements.name.value.trim(),r=t.elements.email.value.trim(),e=t.elements.phone.value.trim(),i=t.elements.address.value.trim();if(!a||!r||!e||!i){n.textContent="Veuillez remplir tous les champs requis.",n.classList.remove("hidden");return}o.disabled=!0,o.textContent="Enregistrement...";try{const c=x().storeId;if(!c)throw new Error("Erreur de configuration : ID du store manquant. Veuillez rafraîchir la page.");const L={name:a,email:r,phone:e,address:i,notes:t.elements.notes.value.trim()},f=l.reduce((z,M)=>z+M.price.amount*M.quantity,0),C={customer:L,items:l,total:f,currency:((s=l[0])==null?void 0:s.price.currency)||"EUR"},h=await k(C,c);if(!h.success||!h.orderId)throw new Error(h.error||"La création de la pré-commande a échoué.");E=h.orderId,localStorage.setItem("zflex_prospectId",h.prospectId),stepAddress.classList.add("hidden"),stepPayment.classList.remove("hidden"),d.style.width="60%",u.textContent="Étape 2: Paiement"}catch(c){n.textContent=c.message||"Une erreur est survenue.",n.classList.remove("hidden"),o.disabled=!1,o.textContent="Continuer vers le paiement"}},A=async a=>{if(a.preventDefault(),n.classList.add("hidden"),!E){n.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",n.classList.remove("hidden");return}const r=I.value,e=y.value;if(!r||!e||e.length<9){n.textContent="Veuillez entrer un numéro de paiement valide pour détecter l'opérateur.",n.classList.remove("hidden");return}m.disabled=!0,m.querySelector(".btn-text").textContent="Initiation du paiement...",m.querySelector(".btn-spinner").classList.remove("hidden");try{const i=x().storeId;if(!i)throw new Error("Erreur de configuration : ID du store manquant. Veuillez rafraîchir la page.");const s=await N(E,i,r,`+243${e}`);s.transactionStatus==="PENDING"?(d.style.width="95%",m.querySelector(".btn-text").textContent="Veuillez confirmer sur votre téléphone..."):s.transactionStatus==="SUCCESS"&&(d.style.width="100%",m.querySelector(".btn-text").textContent="Paiement réussi ! Redirection...",setTimeout(()=>{$(),R.navigateTo(`/order-success/?id=${encodeURIComponent(E)}`)},2e3))}catch(i){let s="Le lancement du paiement a échoué.";i.message.includes("transactionReference already exists")?s="Cette commande a déjà une tentative de paiement. Veuillez rafraîchir la page.":i.message.includes("aucun opérateur")?s="L'opérateur pour ce numéro n'est pas supporté. Veuillez vérifier le numéro.":s=i.message,n.textContent=s,m.disabled=!1,m.querySelector(".btn-text").textContent="Confirmer et Payer",m.querySelector(".btn-spinner").classList.add("hidden")}};return o.addEventListener("click",B),y.addEventListener("input",T),p.addEventListener("click",w),t.addEventListener("submit",A),console.log("[Checkout] Module V10.0 (La Sagesse de Stacy) initialisé."),{destroy:()=>{o.removeEventListener("click",B),y.removeEventListener("input",T),p.removeEventListener("click",w),t.removeEventListener("submit",A),console.log("[Checkout] Module détruit.")}}}export{F as initCheckout};
