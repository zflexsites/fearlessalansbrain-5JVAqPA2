import{g as w,c as P,i as $,a as V,r as z}from"../js/app.js";function A(r){const i=document.getElementById("summary-items-list"),y=document.getElementById("summary-subtotal"),h=document.getElementById("summary-total");if(!i||!y||!h)return;if(!r||r.length===0){i.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}i.innerHTML="";const a={};r.forEach(o=>{const u=document.createElement("div");u.className="flex justify-between text-sm",u.innerHTML=`<div><span class="font-semibold">${o.quantity} x</span> ${o.title}</div><span>${(o.price.amount*o.quantity).toFixed(2)} ${o.price.currency}</span>`,i.appendChild(u);const s=o.price.currency;a[s]||(a[s]=0),a[s]+=o.price.amount*o.quantity}),y.innerHTML="",h.innerHTML="",Object.entries(a).forEach(([o,u])=>{const s=`${Number(u).toFixed(2)} ${o}`;y.innerHTML+=`<div>${s}</div>`,h.innerHTML+=`<div>${s}</div>`})}function D(){const r=document.getElementById("checkout-form");if(!r)return;const i=w()||[];A(i);const y=document.getElementById("step-address"),h=document.getElementById("step-payment"),a=document.getElementById("continue-to-payment-btn"),o=document.getElementById("progress-bar"),u=document.getElementById("checkout-title"),s=document.getElementById("submit-order-btn"),f=document.getElementById("payment-methods"),E=document.getElementById("selected-payment-method"),S=document.getElementById("payment-instructions"),e=document.getElementById("checkout-error"),l=document.getElementById("use-geolocation-btn"),M=document.getElementById("address");let v=null;const L=()=>{if(!navigator.geolocation){e.textContent="La géolocalisation n'est pas supportée par votre navigateur.",e.classList.remove("hidden");return}l.disabled=!0,l.classList.add("animate-pulse");const m={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async t=>{const{latitude:n,longitude:c}=t.coords;try{const d=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${n}&lon=${c}`)).json();if(d&&d.display_name)M.value=d.display_name;else throw new Error("Adresse non trouvée.")}catch{e.textContent="Impossible de convertir les coordonnées en adresse.",e.classList.remove("hidden")}finally{l.disabled=!1,l.classList.remove("animate-pulse")}},t=>{let n="Erreur de géolocalisation.";t.code===t.PERMISSION_DENIED&&(n="Vous avez refusé la permission d'accès à la localisation."),t.code===t.POSITION_UNAVAILABLE&&(n="Votre position n'est pas disponible."),t.code===t.TIMEOUT&&(n="Le service de localisation a mis trop de temps à répondre."),e.textContent=n,e.classList.remove("hidden"),l.disabled=!1,l.classList.remove("animate-pulse")},m)},I=async()=>{var c,p;e.classList.add("hidden");const m=r.elements.name.value.trim(),t=r.elements.phone.value.trim(),n=r.elements.address.value.trim();if(!m||!t||!n){e.textContent="Veuillez remplir tous les champs de livraison requis.",e.classList.remove("hidden");return}a.disabled=!0,a.textContent="Enregistrement...";try{const d={name:m,phone:t,address:n,notes:r.elements.notes.value.trim()},C=JSON.parse(((c=document.querySelector(".zflex-fragment-data"))==null?void 0:c.textContent)||"{}").storeId;if(!C)throw new Error("ID du store manquant.");const T=i.reduce((q,B)=>q+B.price.amount*B.quantity,0),k={customer:d,items:i,total:T,currency:((p=i[0])==null?void 0:p.price.currency)||"EUR"},g=await P(k,C);if(!g.success||!g.orderId)throw new Error("La création de la pré-commande a échoué.");v=g.orderId,localStorage.setItem("zflex_prospectId",g.prospectId),y.classList.add("hidden"),h.classList.remove("hidden"),o.style.width="60%",u.textContent="Étape 2: Paiement"}catch(d){e.textContent=d.message||"Une erreur est survenue.",e.classList.remove("hidden"),a.disabled=!1,a.textContent="Continuer vers le paiement"}},b=m=>{const t=m.target.closest(".payment-method-btn");if(!t)return;document.querySelectorAll(".payment-method-btn").forEach(c=>c.classList.remove("border-primary","ring-2","ring-offset-2")),t.classList.add("border-primary","ring-2","ring-offset-2");const n=t.dataset.method;E.value=n,S.innerHTML=`<p>Vous avez choisi <strong>${n}</strong>. Vous recevrez une notification sur le numéro de téléphone fourni pour valider la transaction.</p>`},x=async m=>{var c;if(m.preventDefault(),!v)return;e.classList.add("hidden");const t=E.value,n=r.elements.payment_phone.value;if(!t){e.textContent="Veuillez choisir une méthode de paiement.",e.classList.remove("hidden");return}if(!n||n.length<9){e.textContent="Veuillez entrer un numéro de téléphone de paiement valide.",e.classList.remove("hidden");return}o.style.width="90%",s.disabled=!0,s.querySelector(".btn-text").textContent="Veuillez valider sur votre téléphone...",s.querySelector(".btn-spinner").classList.remove("hidden");try{const d=JSON.parse(((c=document.querySelector(".zflex-fragment-data"))==null?void 0:c.textContent)||"{}").storeId;await $(v,d,t,n),s.querySelector(".btn-text").textContent="Paiement initié ! Redirection...",setTimeout(()=>{V(),z.navigateTo(`/order-success/?id=${encodeURIComponent(v)}`)},4e3)}catch(p){e.textContent=p.message||"Le lancement du paiement a échoué.",e.classList.remove("hidden"),o.style.width="60%",s.disabled=!1,s.querySelector(".btn-text").textContent="Confirmer et Payer",s.querySelector(".btn-spinner").classList.add("hidden")}};return a.addEventListener("click",I),f.addEventListener("click",b),l.addEventListener("click",L),r.addEventListener("submit",x),console.log("[Checkout] Module V4.2 (Finition Premium) initialisé."),{destroy:()=>{a.removeEventListener("click",I),f.removeEventListener("click",b),l.removeEventListener("click",L),r.removeEventListener("submit",x),console.log("[Checkout] Module détruit.")}}}export{D as initCheckout};
