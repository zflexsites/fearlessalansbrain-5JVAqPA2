import{g as z,a as k,e as q,c as N,i as $,b as R,r as H}from"../js/app.js";function C(){try{const o=document.getElementById("zflex-data");return JSON.parse(o.textContent||"{}")||{}}catch(o){return console.error("[Checkout] Erreur de parsing du tunnel de data:",o),{}}}function D(o){const t=document.getElementById("summary-items-list"),h=document.getElementById("summary-subtotal"),u=document.getElementById("summary-total");if(!t||!h||!u)return;if(!o||o.length===0){t.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}t.innerHTML="";const g={};o.forEach(a=>{const i=document.createElement("div");i.className="flex justify-between text-sm",i.innerHTML=`<div><span class="font-semibold">${a.quantity} x</span> ${a.title}</div><span>${(a.price.amount*a.quantity).toFixed(2)} ${a.price.currency}</span>`,t.appendChild(i);const c=a.price.currency;g[c]||(g[c]=0),g[c]+=a.price.amount*a.quantity}),h.innerHTML="",u.innerHTML="",Object.entries(g).forEach(([a,i])=>{const c=`${Number(i).toFixed(2)} ${a}`;h.innerHTML+=`<div>${c}</div>`,u.innerHTML+=`<div>${c}</div>`})}function _(){const o=document.getElementById("checkout-form");if(!o)return;const t=document.getElementById("checkout-error");(async()=>{const l=localStorage.getItem("zflex_prospectId"),n=C().storeId;if(!(!l||!n))try{const e=await k(n,l);e.success&&e.data&&q.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"On vous reconnaît !",message:"Voulez-vous utiliser les informations de votre dernière visite ?",confirmText:"Oui, utiliser",cancelText:"Non, merci",onConfirm:()=>{o.elements.name.value=e.data.name||"",o.elements.email.value=e.data.email||"",o.elements.phone.value=e.data.phone||"",o.elements.address.value=e.data.address||""}}}))}catch(e){console.warn("Impossible de récupérer les infos du prospect/client:",e),localStorage.removeItem("zflex_prospectId")}})(storeId);const u=z()||[];D(u);const g=document.getElementById("step-address"),a=document.getElementById("step-payment"),i=document.getElementById("continue-to-payment-btn"),c=document.getElementById("progress-bar"),O=document.getElementById("checkout-title"),m=document.getElementById("submit-order-btn"),f=document.getElementById("payment-phone"),b=document.getElementById("operator-logo-container"),I=document.getElementById("selected-payment-method"),B=document.getElementById("payment-instructions"),p=document.getElementById("use-geolocation-btn"),P=document.getElementById("address");let E=null;const S=()=>{const n=f.value.replace(/\s/g,"").substring(0,2);let e=null;const s=["81","82","83"],r=["80","84","85","89"],d=["97","99"],L=["90"];if(s.includes(n)&&(e="MPESA"),r.includes(n)&&(e="ORANGE"),d.includes(n)&&(e="AIRTEL"),L.includes(n)&&(e="AFRICELL"),b.innerHTML="",e){const v=document.createElement("img"),x=e==="ORANGE"?"orangemoney":e==="AIRTEL"?"airtelmoney":e.toLowerCase();v.src=`/img/${x}.png`,v.className="h-6",b.appendChild(v),I.value=e,B.innerHTML=`<p>Opérateur <strong>${e}</strong> détecté. Vous recevrez une notification pour valider.</p>`}else I.value="",B.innerHTML="<p>Veuillez entrer un numéro valide pour détecter l'opérateur.</p>"},T=()=>{if(!navigator.geolocation){t.textContent="La géolocalisation n'est pas supportée par votre navigateur.",t.classList.remove("hidden");return}p.disabled=!0,p.classList.add("animate-pulse");const l={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async n=>{const{latitude:e,longitude:s}=n.coords;try{const d=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${s}`)).json();if(d&&d.display_name)P.value=d.display_name;else throw new Error("Adresse non trouvée.")}catch{t.textContent="Impossible de convertir les coordonnées en adresse.",t.classList.remove("hidden")}finally{p.disabled=!1,p.classList.remove("animate-pulse")}},n=>{let e="Erreur de géolocalisation.";n.code===n.PERMISSION_DENIED&&(e="Vous avez refusé la permission d'accès à la localisation."),n.code===n.POSITION_UNAVAILABLE&&(e="Votre position n'est pas disponible."),n.code===n.TIMEOUT&&(e="Le service de localisation a mis trop de temps à répondre."),t.textContent=e,t.classList.remove("hidden"),p.disabled=!1,p.classList.remove("animate-pulse")},l)},w=async()=>{var r;t.classList.add("hidden");const l=o.elements.name.value.trim(),n=o.elements.email.value.trim(),e=o.elements.phone.value.trim(),s=o.elements.address.value.trim();if(!l||!n||!e||!s){t.textContent="Veuillez remplir tous les champs requis.",t.classList.remove("hidden");return}i.disabled=!0,i.textContent="Enregistrement...";try{const d=C().storeId;if(!d)throw new Error("Erreur de configuration : ID du store manquant. Veuillez rafraîchir la page.");const L={name:l,email:n,phone:e,address:s,notes:o.elements.notes.value.trim()},v=u.reduce((V,M)=>V+M.price.amount*M.quantity,0),x={customer:L,items:u,total:v,currency:((r=u[0])==null?void 0:r.price.currency)||"EUR"},y=await N(x,d);if(!y.success||!y.orderId)throw new Error(y.error||"La création de la pré-commande a échoué.");E=y.orderId,localStorage.setItem("zflex_prospectId",y.prospectId),g.classList.add("hidden"),a.classList.remove("hidden"),c.style.width="60%",O.textContent="Étape 2: Paiement"}catch(d){t.textContent=d.message||"Une erreur est survenue.",t.classList.remove("hidden"),i.disabled=!1,i.textContent="Continuer vers le paiement"}},A=async l=>{if(l.preventDefault(),t.classList.add("hidden"),!E){t.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",t.classList.remove("hidden");return}const n=I.value,e=f.value;if(!n||!e||e.length<9){t.textContent="Veuillez entrer un numéro de paiement valide pour détecter l'opérateur.",t.classList.remove("hidden");return}m.disabled=!0,m.querySelector(".btn-text").textContent="Initiation du paiement...",m.querySelector(".btn-spinner").classList.remove("hidden");try{const s=C().storeId;if(!s)throw new Error("Erreur de configuration : ID du store manquant. Veuillez rafraîchir la page.");const r=await $(E,s,n,`+243${e}`);r.transactionStatus==="PENDING"?(c.style.width="95%",m.querySelector(".btn-text").textContent="Veuillez confirmer sur votre téléphone..."):r.transactionStatus==="SUCCESS"&&(c.style.width="100%",m.querySelector(".btn-text").textContent="Paiement réussi ! Redirection...",setTimeout(()=>{R(),H.navigateTo(`/order-success/?id=${encodeURIComponent(E)}`)},2e3))}catch(s){let r="Le lancement du paiement a échoué.";s.message.includes("transactionReference already exists")?r="Cette commande a déjà une tentative de paiement. Veuillez rafraîchir la page.":s.message.includes("aucun opérateur")?r="L'opérateur pour ce numéro n'est pas supporté. Veuillez vérifier le numéro.":r=s.message,t.textContent=r,m.disabled=!1,m.querySelector(".btn-text").textContent="Confirmer et Payer",m.querySelector(".btn-spinner").classList.add("hidden")}};return i.addEventListener("click",w),f.addEventListener("input",S),p.addEventListener("click",T),o.addEventListener("submit",A),console.log("[Checkout] Module V10.0 (La Sagesse de Stacy) initialisé."),{destroy:()=>{i.removeEventListener("click",w),f.removeEventListener("input",S),p.removeEventListener("click",T),o.removeEventListener("submit",A),console.log("[Checkout] Module détruit.")}}}export{_ as initCheckout};
