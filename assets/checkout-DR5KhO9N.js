import{g as k,c as w,i as T,a as z,r as V}from"../js/app.js";function $(n){const a=document.getElementById("summary-items-list"),u=document.getElementById("summary-subtotal"),m=document.getElementById("summary-total");if(!a||!u||!m)return;if(!n||n.length===0){a.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}a.innerHTML="";const o={};n.forEach(e=>{const c=document.createElement("div");c.className="flex justify-between text-sm",c.innerHTML=`<div><span class="font-semibold">${e.quantity} x</span> ${e.title}</div><span>${(e.price.amount*e.quantity).toFixed(2)} ${e.price.currency}</span>`,a.appendChild(c);const t=e.price.currency;o[t]||(o[t]=0),o[t]+=e.price.amount*e.quantity}),u.innerHTML="",m.innerHTML="",Object.entries(o).forEach(([e,c])=>{const t=`${Number(c).toFixed(2)} ${e}`;u.innerHTML+=`<div>${t}</div>`,m.innerHTML+=`<div>${t}</div>`})}function D(){const n=document.getElementById("checkout-form");if(!n)return;const a=k()||[];$(a);const u=document.getElementById("step-address"),m=document.getElementById("step-payment"),o=document.getElementById("continue-to-payment-btn"),e=document.getElementById("progress-bar"),c=document.getElementById("checkout-title"),t=document.getElementById("submit-order-btn"),g=document.getElementById("payment-methods"),f=document.getElementById("selected-payment-method"),C=document.getElementById("payment-instructions"),r=document.getElementById("checkout-error");let v=null;const E=async()=>{var p,l;r.classList.add("hidden");const d=n.elements.name.value.trim(),s=n.elements.phone.value.trim(),i=n.elements.address.value.trim();if(!d||!s||!i){r.textContent="Veuillez remplir tous les champs de livraison requis.",r.classList.remove("hidden");return}o.disabled=!0,o.textContent="Enregistrement...";try{const b=JSON.parse(((p=document.querySelector(".zflex-fragment-data"))==null?void 0:p.textContent)||"{}").storeId;if(!b)throw new Error("ID du store manquant. Veuillez réessayer.");const B={name:d,phone:s,address:i,notes:n.elements.notes.value.trim()},q=a.reduce((M,x)=>M+x.price.amount*x.quantity,0),S={customer:B,items:a,total:q,currency:((l=a[0])==null?void 0:l.price.currency)||"EUR"},h=await w(S,b);if(!h.success||!h.orderId)throw new Error(h.error||"La création de la pré-commande a échoué.");v=h.orderId,localStorage.setItem("zflex_prospectId",h.prospectId),u.classList.add("hidden"),m.classList.remove("hidden"),e.style.width="60%",c.textContent="Étape 2: Paiement"}catch(y){r.textContent=y.message||"Une erreur est survenue.",r.classList.remove("hidden"),o.disabled=!1,o.textContent="Continuer vers le paiement"}},I=d=>{const s=d.target.closest(".payment-method-btn");s&&(document.querySelectorAll(".payment-method-btn").forEach(i=>i.classList.remove("border-primary","ring-2","ring-offset-2")),s.classList.add("border-primary","ring-2","ring-offset-2"),f.value=s.dataset.method,C.innerHTML=`<p>Vous avez choisi <strong>${s.dataset.method}</strong>. Vous recevrez une notification sur le numéro de téléphone fourni pour valider la transaction.</p>`)},L=async d=>{var p;if(d.preventDefault(),r.classList.add("hidden"),!v){r.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",r.classList.remove("hidden");return}const s=f.value,i=n.elements.payment_phone.value;if(!s||!i||i.length<9){r.textContent="Veuillez choisir une méthode et entrer un numéro de paiement valide.",r.classList.remove("hidden");return}t.disabled=!0,t.querySelector(".btn-text").textContent="Veuillez valider sur votre téléphone...",t.querySelector(".btn-spinner").classList.remove("hidden");try{const y=JSON.parse(((p=document.querySelector(".zflex-fragment-data"))==null?void 0:p.textContent)||"{}").storeId;if(!y)throw new Error("ID du store manquant. Veuillez réessayer.");await T(v,y,s,i),e.style.width="90%",t.querySelector(".btn-text").textContent="Paiement initié ! Redirection...",setTimeout(()=>{z(),V.navigateTo(`/order-success/?id=${encodeURIComponent(v)}`)},4e3)}catch(l){console.error("[Checkout] Erreur lors de l'initiation du paiement:",l),r.textContent=l.message||"Le lancement du paiement a échoué.",r.classList.remove("hidden"),e.style.width="60%",t.disabled=!1,t.querySelector(".btn-text").textContent="Confirmer et Payer",t.querySelector(".btn-spinner").classList.add("hidden")}};return o.addEventListener("click",E),g.addEventListener("click",I),n.addEventListener("submit",L),console.log("[Checkout] Module V7.0 (La Solution Finale) initialisé."),{destroy:()=>{o.removeEventListener("click",E),g.removeEventListener("click",I),n.removeEventListener("submit",L),console.log("[Checkout] Module détruit.")}}}export{D as initCheckout};
