import{g as R,a as F,e as G,c as J,i as K,b as V,d as Q,r as W}from"../js/app.js";function U(){try{const e=document.getElementById("zflex-data")||document.querySelector(".zflex-fragment-data");return!e||!e.textContent?(console.warn("[Checkout] Tunnel de data est vide ou introuvable."),{}):JSON.parse(e.textContent)}catch(e){return console.error("[Checkout] Erreur de parsing du tunnel de data:",e),{}}}function X(){return Math.random().toString(36).slice(2,9)}function Y(e){return`${e}-${Date.now()}-${X()}`}function N(e){return e==null?"":String(e)}function Z(e){if(e){if(typeof e.transactionStatus=="string")return e.transactionStatus;if(e.result&&typeof e.result.transactionStatus=="string")return e.result.transactionStatus;if(e.data&&typeof e.data.transactionStatus=="string")return e.data.transactionStatus;if(typeof e.status=="string")return e.status}}function ee(e){var n,a,v;if(e)return e.error||e.message||((n=e.result)==null?void 0:n.error)||((a=e.result)==null?void 0:a.message)||((v=e.data)==null?void 0:v.error)}function te(e){const n=document.getElementById("summary-items-list"),a=document.getElementById("summary-subtotal"),v=document.getElementById("summary-total");if(!n||!a||!v)return;if(!e||e.length===0){n.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>',a.innerHTML="",v.innerHTML="";return}n.innerHTML="";const h={};e.forEach(i=>{const L=document.createElement("div");L.className="flex justify-between text-sm",L.innerHTML=`<div><span class="font-semibold">${i.quantity} x</span> ${i.title}</div><span>${(i.price.amount*i.quantity).toFixed(2)} ${i.price.currency}</span>`,n.appendChild(L);const E=i.price.currency;h[E]||(h[E]=0),h[E]+=i.price.amount*i.quantity}),a.innerHTML="",v.innerHTML="",Object.entries(h).forEach(([i,L])=>{const E=`${Number(L).toFixed(2)} ${i}`;a.innerHTML+=`<div>${E}</div>`,v.innerHTML+=`<div>${E}</div>`})}function re(){const e=document.getElementById("checkout-form");if(!e)return;const n=document.getElementById("checkout-error");let a=null;const v=async c=>{const r=localStorage.getItem("zflex_prospectId");if(!(!r||!c))try{const t=await F(c,r);t.success&&t.data&&G.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"On vous reconnaît !",message:"Voulez-vous utiliser les informations de votre dernière visite ?",messageHtml:`
                <div style="display:flex;gap:12px;align-items:center">
                  <div style="width:56px;height:56px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:600;color:#111">${(t.data.name||"U").charAt(0)}</div>
                  <div>
                    <div>Nom: <strong>${N(t.data.name)}</strong></div>
                    <div>Tél: <strong>${N(t.data.phone)}</strong></div>
                    <div style="color:#6b7280">${N(t.data.address)}</div>
                  </div>
                </div>
              `,confirmText:"Oui, utiliser",cancelText:"Non, merci",variant:"info",onConfirm:()=>{e.elements.name&&(e.elements.name.value=t.data.name||""),e.elements.email&&(e.elements.email.value=t.data.email||""),e.elements.phone&&(e.elements.phone.value=t.data.phone||""),e.elements.address&&(e.elements.address.value=t.data.address||""),e.elements.notes&&(e.elements.notes.value=t.data.notes||"")}}}))}catch(t){console.warn("Impossible de récupérer les infos du prospect/client:",(t==null?void 0:t.message)||t),String((t==null?void 0:t.message)||"").includes("Aucune information")&&localStorage.removeItem("zflex_prospectId")}},h=U().storeId;if(!h){console.error("[Checkout] Erreur critique : ID du store non trouvé à l'initialisation.");const c=document.querySelector(".lg\\:col-span-3");c&&(c.innerHTML='<div class="text-red-500 p-4 border border-red-200 rounded-lg bg-red-50"><strong>Erreur de chargement.</strong> Impossible de récupérer les informations de la boutique. Veuillez rafraîchir la page.</div>');return}v(h);const i=R()||[];te(i);const L=document.getElementById("step-address"),E=document.getElementById("step-payment"),S=document.getElementById("continue-to-payment-btn"),B=document.getElementById("progress-bar"),H=document.getElementById("checkout-title"),o=document.getElementById("submit-order-btn"),I=document.getElementById("payment-phone"),_=document.getElementById("operator-logo-container"),M=document.getElementById("selected-payment-method"),A=document.getElementById("payment-instructions"),p=document.getElementById("use-geolocation-btn"),j=document.getElementById("address");if(!S||!o){console.error("[Checkout] Boutons manquants.");return}const b=async(c,r,t=null)=>{const u=(c||"").toUpperCase();if(u==="SUCCESS"||u==="SUCCEEDED"||u==="COMPLETED"){o.querySelector(".btn-spinner").classList.add("hidden"),o.querySelector(".btn-text").textContent="Paiement réussi ! Redirection...",B.style.width="100%",setTimeout(()=>{Q();try{W.navigateTo(`/order-success/?id=${encodeURIComponent(a)}`)}catch{window.location.href=`/order-success/?id=${encodeURIComponent(a)}`}},900);return}if(u==="PENDING"){o.querySelector(".btn-spinner").classList.add("hidden"),o.disabled=!1,o.querySelector(".btn-text").textContent="Statut: En attente de confirmation",B.style.width="95%",n.textContent=r||"La transaction est en attente. Veuillez confirmer sur votre téléphone.",n.classList.remove("hidden");return}o.querySelector(".btn-spinner").classList.add("hidden"),o.disabled=!1,o.querySelector(".btn-text").textContent="Confirmer et Payer",n.textContent=r||"Le paiement a échoué. Veuillez réessayer ou contacter le support.",n.classList.remove("hidden")},D=async()=>{var f,l;n.classList.add("hidden");const c=e.elements.name.value.trim(),r=e.elements.email.value.trim(),t=e.elements.phone.value.trim(),u=e.elements.address.value.trim();if(!c||!r||!t||!u){n.textContent="Veuillez remplir tous les champs requis.",n.classList.remove("hidden");return}S.disabled=!0,S.textContent="Enregistrement...";try{const d={name:c,email:r,phone:t,address:u,notes:((f=e.elements.notes)==null?void 0:f.value.trim())||""},w=i.reduce((q,C)=>q+C.price.amount*C.quantity,0),T={customer:d,items:i,total:w,currency:((l=i[0])==null?void 0:l.price.currency)||"EUR"},y=await J(T,h);if(!y.success||!y.orderId)throw new Error(y.error||"La création de la pré-commande a échoué.");a=y.orderId,y.prospectId&&localStorage.setItem("zflex_prospectId",y.prospectId),L.classList.add("hidden"),E.classList.remove("hidden"),B.style.width="60%",H.textContent="Étape 2: Paiement"}catch(d){n.textContent=d.message||"Une erreur est survenue.",n.classList.remove("hidden"),S.disabled=!1,S.textContent="Continuer vers le paiement"}},k=async c=>{var d,w,T,y,q,C,O;if(c.preventDefault(),n.classList.add("hidden"),!a){n.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",n.classList.remove("hidden");return}const r=M.value,u=(I.value||"").replace(/\D/g,"");if(!r||!u||u.length<9){n.textContent="Veuillez entrer un numéro de paiement valide pour détecter l'opérateur.",n.classList.remove("hidden");return}o.disabled=!0,o.querySelector(".btn-text").textContent="Initiation du paiement...",o.querySelector(".btn-spinner").classList.remove("hidden");const f=`zflex_txref_${a}`;let l=localStorage.getItem(f);if(!l){l=Y(a);try{localStorage.setItem(f,l)}catch{}}try{const g=U().storeId;if(!g)throw new Error("Erreur de configuration : ID du store manquant. Veuillez rafraîchir la page.");const x=await K(a,g,r,`+243${u}`,l),m=ee(x),P=Z(x);if(m)if(String(m).toLowerCase().includes("transactionreference already exists")||String(m).toLowerCase().includes("transactionreference")&&String(m).toLowerCase().includes("exists"))try{const s=await V(a,g),$=s.transactionStatus||((d=s.result)==null?void 0:d.transactionStatus)||s.status||((w=s.data)==null?void 0:w.transactionStatus)||s.statusText||(s.success?(T=s.result)==null?void 0:T.transactionStatus:void 0),z=s.message||((y=s.result)==null?void 0:y.message)||s.error||"La transaction existe déjà. Nous vérifions son statut.";await b($,z,s);return}catch{n.textContent="Une tentative de paiement existe déjà pour cette commande. Nous n'avons pas pu vérifier son statut automatiquement. Vérifiez votre solde et contactez le support si nécessaire.",n.classList.remove("hidden"),o.querySelector(".btn-spinner").classList.add("hidden"),o.disabled=!1,o.querySelector(".btn-text").textContent="Confirmer et Payer";return}else throw new Error(String(m));if(P)if(P.toUpperCase()==="PENDING"){await b("PENDING","Veuillez confirmer sur votre téléphone...");return}else if(["SUCCESS","SUCCEEDED","COMPLETED"].includes(P.toUpperCase())){await b("SUCCESS","Paiement confirmé.");return}else throw new Error(`Statut de transaction inattendu: ${P}`);try{const s=await V(a,g),$=s.transactionStatus||((q=s.result)==null?void 0:q.transactionStatus)||s.status||((C=s.data)==null?void 0:C.transactionStatus),z=s.message||((O=s.result)==null?void 0:O.message)||"";await b($,z,s)}catch{throw new Error("Statut de transaction inattendu.")}}catch(g){const x=(g==null?void 0:g.message)||String(g);let m="Le lancement du paiement a échoué.";x.includes("transactionReference already exists")?m="Une tentative de paiement existe déjà pour cette commande. Nous vérifions son statut...":x.includes("transactionReference")?m="Erreur liée à la référence de transaction. Ne relancez pas le paiement automatiquement.":x.includes("aucun opérateur")||x.toLowerCase().includes("operator")?m="L'opérateur pour ce numéro n'est pas supporté. Veuillez vérifier le numéro.":m=x,n.textContent=m,n.classList.remove("hidden"),o.querySelector(".btn-spinner").classList.add("hidden"),o.disabled=!1,o.querySelector(".btn-text").textContent="Confirmer et Payer"}};return S.addEventListener("click",D),I.addEventListener("input",()=>{const r=(I.value||"").replace(/\D/g,"").substring(0,2),t=["81","82","83"],u=["80","84","85","89"],f=["97","99"],l=["90"];let d=null;t.includes(r)&&(d="MPESA"),u.includes(r)&&(d="ORANGE"),f.includes(r)&&(d="AIRTEL"),l.includes(r)&&(d="AFRICELL"),_.innerHTML="",d?(M.value=d,A.innerHTML=`<p>Opérateur <strong>${d}</strong> détecté. Vous recevrez une notification pour valider.</p>`):(M.value="",A.innerHTML="<p>Veuillez entrer un numéro valide pour détecter l'opérateur.</p>")}),p&&p.addEventListener("click",()=>{if(!navigator.geolocation){n.textContent="La géolocalisation n'est pas supportée par votre navigateur.",n.classList.remove("hidden");return}p.disabled=!0,p.classList.add("animate-pulse");const c={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async r=>{const{latitude:t,longitude:u}=r.coords;try{const l=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${u}`)).json();if(l&&l.display_name)j.value=l.display_name;else throw new Error("Adresse non trouvée.")}catch{n.textContent="Impossible de convertir les coordonnées en adresse.",n.classList.remove("hidden")}finally{p.disabled=!1,p.classList.remove("animate-pulse")}},r=>{let t="Erreur de géolocalisation.";r.code===r.PERMISSION_DENIED&&(t="Vous avez refusé la permission d'accès à la localisation."),r.code===r.POSITION_UNAVAILABLE&&(t="Votre position n'est pas disponible."),r.code===r.TIMEOUT&&(t="Le service de localisation a mis trop de temps à répondre."),n.textContent=t,n.classList.remove("hidden"),p.disabled=!1,p.classList.remove("animate-pulse")},c)}),e.addEventListener("submit",k),console.log("[Checkout] Module V13.0 initialisé."),{destroy:()=>{S.removeEventListener("click",D),I.removeEventListener("input",()=>{}),p&&p.removeEventListener("click",()=>{}),e.removeEventListener("submit",k),console.log("[Checkout] Module détruit.")}}}export{re as initCheckout};
