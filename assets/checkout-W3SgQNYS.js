import{g as w,c as P,i as V,a as $,r as z}from"../js/app.js";function A(s){const i=document.getElementById("summary-items-list"),d=document.getElementById("summary-subtotal"),y=document.getElementById("summary-total");if(!i||!d||!y)return;if(!s||s.length===0){i.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}i.innerHTML="";const p={};s.forEach(n=>{const a=document.createElement("div");a.className="flex justify-between text-sm",a.innerHTML=`<div><span class="font-semibold">${n.quantity} x</span> ${n.title}</div><span>${(n.price.amount*n.quantity).toFixed(2)} ${n.price.currency}</span>`,i.appendChild(a);const c=n.price.currency;p[c]||(p[c]=0),p[c]+=n.price.amount*n.quantity}),d.innerHTML="",y.innerHTML="",Object.entries(p).forEach(([n,a])=>{const c=`${Number(a).toFixed(2)} ${n}`;d.innerHTML+=`<div>${c}</div>`,y.innerHTML+=`<div>${c}</div>`})}function O(){var B;const s=document.getElementById("checkout-form");if(!s)return;let i=null;try{const o=JSON.parse(((B=document.querySelector(".zflex-fragment-data"))==null?void 0:B.textContent)||"{}");if(!o.storeId)throw new Error("ID du store non trouvé dans le tunnel de data. Le routeur est peut-être trop rapide.");i=o.storeId}catch(o){console.error("[Checkout] Erreur critique à l'initialisation:",o.message);const e=document.querySelector(".lg\\:col-span-3");e&&(e.innerHTML='<div class="text-red-500 p-4 border border-red-200 rounded-lg bg-red-50"><strong>Erreur de chargement.</strong> Impossible de récupérer les informations de la boutique. Veuillez rafraîchir la page.</div>');return}const d=w()||[];A(d);const y=document.getElementById("step-address"),p=document.getElementById("step-payment"),n=document.getElementById("continue-to-payment-btn"),a=document.getElementById("progress-bar"),c=document.getElementById("checkout-title"),m=document.getElementById("submit-order-btn"),E=document.getElementById("payment-methods"),L=document.getElementById("selected-payment-method"),M=document.getElementById("payment-instructions"),t=document.getElementById("checkout-error"),l=document.getElementById("use-geolocation-btn"),T=document.getElementById("address");let h=null;const b=()=>{if(!navigator.geolocation){t.textContent="La géolocalisation n'est pas supportée par votre navigateur.",t.classList.remove("hidden");return}l.disabled=!0,l.classList.add("animate-pulse");const o={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async e=>{const{latitude:r,longitude:u}=e.coords;try{const g=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${u}`)).json();if(g&&g.display_name)T.value=g.display_name;else throw new Error("Adresse non trouvée.")}catch{t.textContent="Impossible de convertir les coordonnées en adresse.",t.classList.remove("hidden")}finally{l.disabled=!1,l.classList.remove("animate-pulse")}},e=>{let r="Erreur de géolocalisation.";e.code===e.PERMISSION_DENIED&&(r="Vous avez refusé la permission d'accès à la localisation."),e.code===e.POSITION_UNAVAILABLE&&(r="Votre position n'est pas disponible."),e.code===e.TIMEOUT&&(r="Le service de localisation a mis trop de temps à répondre."),t.textContent=r,t.classList.remove("hidden"),l.disabled=!1,l.classList.remove("animate-pulse")},o)},I=async()=>{var u;t.classList.add("hidden");const o=s.elements.name.value.trim(),e=s.elements.phone.value.trim(),r=s.elements.address.value.trim();if(!o||!e||!r){t.textContent="Veuillez remplir tous les champs de livraison requis.",t.classList.remove("hidden");return}n.disabled=!0,n.textContent="Enregistrement...";try{const v={name:o,phone:e,address:r,notes:s.elements.notes.value.trim()},g=d.reduce((S,q)=>S+q.price.amount*q.quantity,0),k={customer:v,items:d,total:g,currency:((u=d[0])==null?void 0:u.price.currency)||"EUR"},f=await P(k,i);if(!f.success||!f.orderId)throw h=null,new Error(f.error||"La création de la pré-commande a échoué.");h=f.orderId,localStorage.setItem("zflex_prospectId",f.prospectId),y.classList.add("hidden"),p.classList.remove("hidden"),a.style.width="60%",c.textContent="Étape 2: Paiement"}catch(v){t.textContent=v.message||"Une erreur est survenue.",t.classList.remove("hidden"),n.disabled=!1,n.textContent="Continuer vers le paiement"}},x=o=>{const e=o.target.closest(".payment-method-btn");if(!e)return;document.querySelectorAll(".payment-method-btn").forEach(u=>u.classList.remove("border-primary","ring-2","ring-offset-2")),e.classList.add("border-primary","ring-2","ring-offset-2");const r=e.dataset.method;L.value=r,M.innerHTML=`<p>Vous avez choisi <strong>${r}</strong>. Vous recevrez une notification sur le numéro de téléphone fourni pour valider la transaction.</p>`},C=async o=>{if(o.preventDefault(),t.classList.add("hidden"),!h){t.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir la page.",t.classList.remove("hidden");return}const e=L.value,r=s.elements.payment_phone.value;if(!e||!r||r.length<9){t.textContent="Veuillez choisir une méthode et entrer un numéro de paiement valide.",t.classList.remove("hidden");return}a.style.width="90%",m.disabled=!0,m.querySelector(".btn-text").textContent="Veuillez valider sur votre téléphone...",m.querySelector(".btn-spinner").classList.remove("hidden");try{await V(h,i,e,r),m.querySelector(".btn-text").textContent="Paiement initié ! Redirection...",setTimeout(()=>{$(),z.navigateTo(`/order-success/?id=${encodeURIComponent(h)}`)},4e3)}catch(u){t.textContent=u.message||"Le lancement du paiement a échoué.",t.classList.remove("hidden"),a.style.width="60%",m.disabled=!1,m.querySelector(".btn-text").textContent="Confirmer et Payer",m.querySelector(".btn-spinner").classList.add("hidden")}};return n.addEventListener("click",I),E.addEventListener("click",x),l.addEventListener("click",b),s.addEventListener("submit",C),console.log("[Checkout] Module V5.1 (Le Bunker) initialisé."),{destroy:()=>{n.removeEventListener("click",I),E.removeEventListener("click",x),l.removeEventListener("click",b),s.removeEventListener("submit",C),console.log("[Checkout] Module détruit.")}}}export{O as initCheckout};
