import{g as P,a as V,e as k,c as N,i as $,b as R,r as H}from"../js/app.js";function M(){try{const t=document.getElementById("zflex-data")||document.querySelector(".zflex-fragment-data");return!t||!t.textContent?(console.warn("[Checkout] Tunnel de data est vide ou introuvable."),{}):JSON.parse(t.textContent)}catch(t){return console.error("[Checkout] Erreur de parsing du tunnel de data:",t),{}}}function D(t){const n=document.getElementById("summary-items-list"),f=document.getElementById("summary-subtotal"),p=document.getElementById("summary-total");if(!n||!f||!p)return;if(!t||t.length===0){n.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}n.innerHTML="";const l={};t.forEach(c=>{const g=document.createElement("div");g.className="flex justify-between text-sm",g.innerHTML=`<div><span class="font-semibold">${c.quantity} x</span> ${c.title}</div><span>${(c.price.amount*c.quantity).toFixed(2)} ${c.price.currency}</span>`,n.appendChild(g);const s=c.price.currency;l[s]||(l[s]=0),l[s]+=c.price.amount*c.quantity}),f.innerHTML="",p.innerHTML="",Object.entries(l).forEach(([c,g])=>{const s=`${Number(g).toFixed(2)} ${c}`;f.innerHTML+=`<div>${s}</div>`,p.innerHTML+=`<div>${s}</div>`})}function _(){const t=document.getElementById("checkout-form");if(!t)return;const n=document.getElementById("checkout-error"),f=async a=>{const r=localStorage.getItem("zflex_prospectId");if(!(!r||!a))try{const e=await V({storeId:a,prospectId:r});e.success&&e.data&&k.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"On vous reconnaît !",message:"Voulez-vous utiliser les informations de votre dernière visite ?",confirmText:"Oui, utiliser",cancelText:"Non, merci",onConfirm:()=>{t.elements.name.value=e.data.name||"",t.elements.email.value=e.data.email||"",t.elements.phone.value=e.data.phone||"",t.elements.address.value=e.data.address||""}}}))}catch(e){console.warn("Impossible de récupérer les infos du prospect/client:",e.message),e.message.includes("Aucune information")&&localStorage.removeItem("zflex_prospectId")}},p=M().storeId;if(!p){console.error("[Checkout] Erreur critique : ID du store non trouvé à l'initialisation.");const a=document.querySelector(".lg\\:col-span-3");a&&(a.innerHTML='<div class="text-red-500 p-4 border border-red-200 rounded-lg bg-red-50"><strong>Erreur de chargement.</strong> Impossible de récupérer les informations de la boutique. Veuillez rafraîchir la page.</div>');return}f(p);const l=P()||[];D(l);const c=document.getElementById("step-address"),g=document.getElementById("step-payment"),s=document.getElementById("continue-to-payment-btn"),I=document.getElementById("progress-bar"),q=document.getElementById("checkout-title"),u=document.getElementById("submit-order-btn"),h=document.getElementById("payment-phone"),x=document.getElementById("operator-logo-container"),L=document.getElementById("selected-payment-method"),b=document.getElementById("payment-instructions"),m=document.getElementById("use-geolocation-btn"),O=document.getElementById("address");let E=null;const T=()=>{const r=h.value.replace(/\s/g,"").substring(0,2);let e=null;const i=["81","82","83"],o=["80","84","85","89"],d=["97","99"],C=["90"];if(i.includes(r)&&(e="MPESA"),o.includes(r)&&(e="ORANGE"),d.includes(r)&&(e="AIRTEL"),C.includes(r)&&(e="AFRICELL"),x.innerHTML="",e){const y=document.createElement("img"),v=e==="ORANGE"?"orangemoney":e==="AIRTEL"?"airtelmoney":e.toLowerCase();y.src=`/img/${v}.png`,y.className="h-6",x.appendChild(y),L.value=e,b.innerHTML=`<p>Opérateur <strong>${e}</strong> détecté. Vous recevrez une notification pour valider.</p>`}else L.value="",b.innerHTML="<p>Veuillez entrer un numéro valide pour détecter l'opérateur.</p>"},B=()=>{if(!navigator.geolocation){n.textContent="La géolocalisation n'est pas supportée par votre navigateur.",n.classList.remove("hidden");return}m.disabled=!0,m.classList.add("animate-pulse");const a={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async r=>{const{latitude:e,longitude:i}=r.coords;try{const d=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${i}`)).json();if(d&&d.display_name)O.value=d.display_name;else throw new Error("Adresse non trouvée.")}catch{n.textContent="Impossible de convertir les coordonnées en adresse.",n.classList.remove("hidden")}finally{m.disabled=!1,m.classList.remove("animate-pulse")}},r=>{let e="Erreur de géolocalisation.";r.code===r.PERMISSION_DENIED&&(e="Vous avez refusé la permission d'accès à la localisation."),r.code===r.POSITION_UNAVAILABLE&&(e="Votre position n'est pas disponible."),r.code===r.TIMEOUT&&(e="Le service de localisation a mis trop de temps à répondre."),n.textContent=e,n.classList.remove("hidden"),m.disabled=!1,m.classList.remove("animate-pulse")},a)},S=async()=>{var o;n.classList.add("hidden");const a=t.elements.name.value.trim(),r=t.elements.email.value.trim(),e=t.elements.phone.value.trim(),i=t.elements.address.value.trim();if(!a||!r||!e||!i){n.textContent="Veuillez remplir tous les champs requis.",n.classList.remove("hidden");return}s.disabled=!0,s.textContent="Enregistrement...";try{const d={name:a,email:r,phone:e,address:i,notes:t.elements.notes.value.trim()},C=l.reduce((z,A)=>z+A.price.amount*A.quantity,0),y={customer:d,items:l,total:C,currency:((o=l[0])==null?void 0:o.price.currency)||"EUR"},v=await N(y,p);if(!v.success||!v.orderId)throw new Error(v.error||"La création de la pré-commande a échoué.");E=v.orderId,localStorage.setItem("zflex_prospectId",v.prospectId),c.classList.add("hidden"),g.classList.remove("hidden"),I.style.width="60%",q.textContent="Étape 2: Paiement"}catch(d){n.textContent=d.message||"Une erreur est survenue.",n.classList.remove("hidden"),s.disabled=!1,s.textContent="Continuer vers le paiement"}},w=async a=>{if(a.preventDefault(),n.classList.add("hidden"),!E){n.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",n.classList.remove("hidden");return}const r=L.value,e=h.value;if(!r||!e||e.length<9){n.textContent="Veuillez entrer un numéro de paiement valide pour détecter l'opérateur.",n.classList.remove("hidden");return}u.disabled=!0,u.querySelector(".btn-text").textContent="Initiation du paiement...",u.querySelector(".btn-spinner").classList.remove("hidden");try{const i=M().storeId;if(!i)throw new Error("Erreur de configuration : ID du store manquant. Veuillez rafraîchir la page.");const o=await $(E,i,r,`+243${e}`);o.transactionStatus==="PENDING"?(I.style.width="95%",u.querySelector(".btn-text").textContent="Veuillez confirmer sur votre téléphone..."):o.transactionStatus==="SUCCESS"&&(I.style.width="100%",u.querySelector(".btn-text").textContent="Paiement réussi ! Redirection...",setTimeout(()=>{R(),H.navigateTo(`/order-success/?id=${encodeURIComponent(E)}`)},2e3))}catch(i){let o="Le lancement du paiement a échoué.";i.message.includes("transactionReference already exists")?o="Cette commande a déjà une tentative de paiement. Veuillez rafraîchir la page.":i.message.includes("aucun opérateur")?o="L'opérateur pour ce numéro n'est pas supporté. Veuillez vérifier le numéro.":o=i.message,n.textContent=o,u.disabled=!1,u.querySelector(".btn-text").textContent="Confirmer et Payer",u.querySelector(".btn-spinner").classList.add("hidden")}};return s.addEventListener("click",S),h.addEventListener("input",T),m.addEventListener("click",B),t.addEventListener("submit",w),console.log("[Checkout] Module V12.0 (La Correction Finale) initialisé."),{destroy:()=>{s.removeEventListener("click",S),h.removeEventListener("input",T),m.removeEventListener("click",B),t.removeEventListener("submit",w),console.log("[Checkout] Module détruit.")}}}export{_ as initCheckout};
