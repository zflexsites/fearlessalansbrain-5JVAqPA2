import{g as P,a as k,e as z,c as V,i as N,b as $,r as R}from"../js/app.js";function H(){try{const t=document.getElementById("zflex-data")||document.querySelector(".zflex-fragment-data");return!t||!t.textContent?(console.warn("[Checkout] Tunnel de data est vide ou introuvable."),{}):JSON.parse(t.textContent)}catch(t){return console.error("[Checkout] Erreur de parsing du tunnel de data:",t),{}}}function F(t){const n=document.getElementById("summary-items-list"),y=document.getElementById("summary-subtotal"),u=document.getElementById("summary-total");if(!n||!y||!u)return;if(!t||t.length===0){n.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}n.innerHTML="";const l={};t.forEach(i=>{const g=document.createElement("div");g.className="flex justify-between text-sm",g.innerHTML=`<div><span class="font-semibold">${i.quantity} x</span> ${i.title}</div><span>${(i.price.amount*i.quantity).toFixed(2)} ${i.price.currency}</span>`,n.appendChild(g);const r=i.price.currency;l[r]||(l[r]=0),l[r]+=i.price.amount*i.quantity}),y.innerHTML="",u.innerHTML="",Object.entries(l).forEach(([i,g])=>{const r=`${Number(g).toFixed(2)} ${i}`;y.innerHTML+=`<div>${r}</div>`,u.innerHTML+=`<div>${r}</div>`})}function _(){const t=document.getElementById("checkout-form");if(!t)return;const n=document.getElementById("checkout-error"),y=async s=>{const o=localStorage.getItem("zflex_prospectId");if(!(!o||!s))try{const e=await k({storeId:s,prospectId:o});e.success&&e.data&&z.dispatchEvent(new CustomEvent("dialog:show",{detail:{title:"On vous reconnaît !",message:"Voulez-vous utiliser les informations de votre dernière visite ?",confirmText:"Oui, utiliser",cancelText:"Non, merci",onConfirm:()=>{t.elements.name.value=e.data.name||"",t.elements.email.value=e.data.email||"",t.elements.phone.value=e.data.phone||"",t.elements.address.value=e.data.address||""}}}))}catch(e){console.warn("Impossible de récupérer les infos du prospect/client:",e),localStorage.removeItem("zflex_prospectId")}},u=H().storeId;if(!u){console.error("[Checkout] Erreur critique : ID du store non trouvé à l'initialisation.");const s=document.querySelector(".lg\\:col-span-3");s&&(s.innerHTML='<div class="text-red-500 p-4 border border-red-200 rounded-lg bg-red-50"><strong>Erreur de chargement.</strong> Impossible de récupérer les informations de la boutique. Veuillez rafraîchir la page.</div>');return}y(u);const l=P()||[];F(l);const i=document.getElementById("step-address"),g=document.getElementById("step-payment"),r=document.getElementById("continue-to-payment-btn"),I=document.getElementById("progress-bar"),w=document.getElementById("checkout-title"),m=document.getElementById("submit-order-btn"),h=document.getElementById("payment-phone"),x=document.getElementById("operator-logo-container"),L=document.getElementById("selected-payment-method"),b=document.getElementById("payment-instructions"),p=document.getElementById("use-geolocation-btn"),O=document.getElementById("address");let E=null;const T=()=>{const o=h.value.replace(/\s/g,"").substring(0,2);let e=null;const a=["81","82","83"],c=["80","84","85","89"],d=["97","99"],C=["90"];if(a.includes(o)&&(e="MPESA"),c.includes(o)&&(e="ORANGE"),d.includes(o)&&(e="AIRTEL"),C.includes(o)&&(e="AFRICELL"),x.innerHTML="",e){const f=document.createElement("img"),v=e==="ORANGE"?"orangemoney":e==="AIRTEL"?"airtelmoney":e.toLowerCase();f.src=`/img/${v}.png`,f.className="h-6",x.appendChild(f),L.value=e,b.innerHTML=`<p>Opérateur <strong>${e}</strong> détecté. Vous recevrez une notification pour valider.</p>`}else L.value="",b.innerHTML="<p>Veuillez entrer un numéro valide pour détecter l'opérateur.</p>"},B=()=>{if(!navigator.geolocation){n.textContent="La géolocalisation n'est pas supportée par votre navigateur.",n.classList.remove("hidden");return}p.disabled=!0,p.classList.add("animate-pulse");const s={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async o=>{const{latitude:e,longitude:a}=o.coords;try{const d=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${a}`)).json();if(d&&d.display_name)O.value=d.display_name;else throw new Error("Adresse non trouvée.")}catch{n.textContent="Impossible de convertir les coordonnées en adresse.",n.classList.remove("hidden")}finally{p.disabled=!1,p.classList.remove("animate-pulse")}},o=>{let e="Erreur de géolocalisation.";o.code===o.PERMISSION_DENIED&&(e="Vous avez refusé la permission d'accès à la localisation."),o.code===o.POSITION_UNAVAILABLE&&(e="Votre position n'est pas disponible."),o.code===o.TIMEOUT&&(e="Le service de localisation a mis trop de temps à répondre."),n.textContent=e,n.classList.remove("hidden"),p.disabled=!1,p.classList.remove("animate-pulse")},s)},S=async()=>{var c;n.classList.add("hidden");const s=t.elements.name.value.trim(),o=t.elements.email.value.trim(),e=t.elements.phone.value.trim(),a=t.elements.address.value.trim();if(!s||!o||!e||!a){n.textContent="Veuillez remplir tous les champs requis.",n.classList.remove("hidden");return}r.disabled=!0,r.textContent="Enregistrement...";try{const d={name:s,email:o,phone:e,address:a,notes:t.elements.notes.value.trim()},C=l.reduce((q,A)=>q+A.price.amount*A.quantity,0),f={customer:d,items:l,total:C,currency:((c=l[0])==null?void 0:c.price.currency)||"EUR"},v=await V(f,u);if(!v.success||!v.orderId)throw new Error(v.error||"La création de la pré-commande a échoué.");E=v.orderId,localStorage.setItem("zflex_prospectId",v.prospectId),i.classList.add("hidden"),g.classList.remove("hidden"),I.style.width="60%",w.textContent="Étape 2: Paiement"}catch(d){n.textContent=d.message||"Une erreur est survenue.",n.classList.remove("hidden"),r.disabled=!1,r.textContent="Continuer vers le paiement"}},M=async s=>{if(s.preventDefault(),n.classList.add("hidden"),!E){n.textContent="Erreur critique : ID de commande manquant. Veuillez rafraîchir.",n.classList.remove("hidden");return}const o=L.value,e=h.value;if(!o||!e||e.length<9){n.textContent="Veuillez entrer un numéro de paiement valide pour détecter l'opérateur.",n.classList.remove("hidden");return}m.disabled=!0,m.querySelector(".btn-text").textContent="Initiation du paiement...",m.querySelector(".btn-spinner").classList.remove("hidden");try{const a=await N(E,u,o,`+243${e}`);a.transactionStatus==="PENDING"?(I.style.width="95%",m.querySelector(".btn-text").textContent="Veuillez confirmer sur votre téléphone..."):a.transactionStatus==="SUCCESS"&&(I.style.width="100%",m.querySelector(".btn-text").textContent="Paiement réussi ! Redirection...",setTimeout(()=>{$(),R.navigateTo(`/order-success/?id=${encodeURIComponent(E)}`)},2e3))}catch(a){let c="Le lancement du paiement a échoué.";a.message.includes("transactionReference already exists")?c="Cette commande a déjà une tentative de paiement. Veuillez rafraîchir la page.":a.message.includes("aucun opérateur")?c="L'opérateur pour ce numéro n'est pas supporté. Veuillez vérifier le numéro.":c=a.message,n.textContent=c,m.disabled=!1,m.querySelector(".btn-text").textContent="Confirmer et Payer",m.querySelector(".btn-spinner").classList.add("hidden")}};return r.addEventListener("click",S),h.addEventListener("input",T),p.addEventListener("click",B),t.addEventListener("submit",M),console.log("[Checkout] Module V11.0 (La Correction Finale) initialisé."),{destroy:()=>{r.removeEventListener("click",S),h.removeEventListener("input",T),p.removeEventListener("click",B),t.removeEventListener("submit",M),console.log("[Checkout] Module détruit.")}}}export{_ as initCheckout};
