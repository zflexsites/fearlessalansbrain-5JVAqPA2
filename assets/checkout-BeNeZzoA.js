import{g as q,c as M,i as k,a as T,r as w}from"../js/app.js";function V(o){const a=document.getElementById("summary-items-list"),u=document.getElementById("summary-subtotal"),m=document.getElementById("summary-total");if(!a||!u||!m)return;if(!o||o.length===0){a.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}a.innerHTML="";const s={};o.forEach(e=>{const c=document.createElement("div");c.className="flex justify-between text-sm",c.innerHTML=`<div><span class="font-semibold">${e.quantity} x</span> ${e.title}</div><span>${(e.price.amount*e.quantity).toFixed(2)} ${e.price.currency}</span>`,a.appendChild(c);const t=e.price.currency;s[t]||(s[t]=0),s[t]+=e.price.amount*e.quantity}),u.innerHTML="",m.innerHTML="",Object.entries(s).forEach(([e,c])=>{const t=`${Number(c).toFixed(2)} ${e}`;u.innerHTML+=`<div>${t}</div>`,m.innerHTML+=`<div>${t}</div>`})}function z(){const o=document.getElementById("checkout-form");if(!o)return;const a=q()||[];V(a);const u=document.getElementById("step-address"),m=document.getElementById("step-payment"),s=document.getElementById("continue-to-payment-btn"),e=document.getElementById("progress-bar"),c=document.getElementById("checkout-title"),t=document.getElementById("submit-order-btn"),f=document.getElementById("payment-methods"),v=document.getElementById("selected-payment-method"),x=document.getElementById("payment-instructions"),r=document.getElementById("checkout-error");let p=null;const E=async()=>{var d,i;if(r.classList.add("hidden"),!o.checkValidity()){r.textContent="Veuillez remplir tous les champs de livraison requis.",r.classList.remove("hidden"),o.reportValidity();return}s.disabled=!0,s.textContent="Enregistrement...";try{const n=new FormData(o),l={name:String(n.get("name")||""),phone:String(n.get("phone")||""),address:String(n.get("address")||""),notes:String(n.get("notes")||"")},y=JSON.parse(((d=document.querySelector(".zflex-fragment-data"))==null?void 0:d.textContent)||"{}").storeId;if(!y)throw new Error("ID du store manquant.");const C=a.reduce((S,b)=>S+b.price.amount*b.quantity,0),B={customer:l,items:a,total:C,currency:((i=a[0])==null?void 0:i.price.currency)||"EUR"},h=await M(B,y);if(!h.success||!h.orderId)throw new Error("La création de la pré-commande a échoué.");p=h.orderId,localStorage.setItem("zflex_prospectId",h.prospectId),u.classList.add("hidden"),m.classList.remove("hidden"),e.style.width="60%",c.textContent="Étape 2: Paiement"}catch(n){r.textContent=n.message||"Une erreur est survenue.",r.classList.remove("hidden"),s.disabled=!1,s.textContent="Continuer vers le paiement"}},I=d=>{const i=d.target.closest(".payment-method-btn");if(!i)return;document.querySelectorAll(".payment-method-btn").forEach(l=>l.classList.remove("border-primary","ring-2","ring-offset-2")),i.classList.add("border-primary","ring-2","ring-offset-2");const n=i.dataset.method;v.value=n,x.innerHTML=`<p>Vous avez choisi <strong>${n}</strong>. Vous recevrez une notification sur le numéro de téléphone fourni pour valider la transaction.</p>`},L=async d=>{var l;if(d.preventDefault(),!p)return;r.classList.add("hidden");const i=v.value,n=o.elements.payment_phone.value;if(!i){r.textContent="Veuillez choisir une méthode de paiement.",r.classList.remove("hidden");return}if(!n||n.length<9){r.textContent="Veuillez entrer un numéro de téléphone de paiement valide.",r.classList.remove("hidden");return}e.style.width="90%",t.disabled=!0,t.querySelector(".btn-text").textContent="Veuillez valider sur votre téléphone...",t.querySelector(".btn-spinner").classList.remove("hidden");try{const y=JSON.parse(((l=document.querySelector(".zflex-fragment-data"))==null?void 0:l.textContent)||"{}").storeId;await k(p,y,i,n),t.querySelector(".btn-text").textContent="Paiement initié ! Redirection...",setTimeout(()=>{T(),w.navigateTo(`/order-success/?id=${encodeURIComponent(p)}`)},4e3)}catch(g){r.textContent=g.message||"Le lancement du paiement a échoué.",r.classList.remove("hidden"),e.style.width="60%",t.disabled=!1,t.querySelector(".btn-text").textContent="Confirmer et Payer",t.querySelector(".btn-spinner").classList.add("hidden")}};return s.addEventListener("click",E),f.addEventListener("click",I),o.addEventListener("submit",L),console.log("[Checkout] Module V4.1 (Blindé) initialisé."),{destroy:()=>{s.removeEventListener("click",E),f.removeEventListener("click",I),o.removeEventListener("submit",L),console.log("[Checkout] Module détruit.")}}}export{z as initCheckout};
