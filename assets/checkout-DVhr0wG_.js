import{g as V,c as z,i as P,a as $,r as A}from"../js/app.js";function D(s){const i=document.getElementById("summary-items-list"),y=document.getElementById("summary-subtotal"),h=document.getElementById("summary-total");if(!i||!y||!h)return;if(!s||s.length===0){i.innerHTML='<p class="text-sm text-center">Votre panier est vide.</p>';return}i.innerHTML="";const a={};s.forEach(r=>{const u=document.createElement("div");u.className="flex justify-between text-sm",u.innerHTML=`<div><span class="font-semibold">${r.quantity} x</span> ${r.title}</div><span>${(r.price.amount*r.quantity).toFixed(2)} ${r.price.currency}</span>`,i.appendChild(u);const o=r.price.currency;a[o]||(a[o]=0),a[o]+=r.price.amount*r.quantity}),y.innerHTML="",h.innerHTML="",Object.entries(a).forEach(([r,u])=>{const o=`${Number(u).toFixed(2)} ${r}`;y.innerHTML+=`<div>${o}</div>`,h.innerHTML+=`<div>${o}</div>`})}function H(){const s=document.getElementById("checkout-form");if(!s)return;const i=V()||[];D(i);const y=document.getElementById("step-address"),h=document.getElementById("step-payment"),a=document.getElementById("continue-to-payment-btn"),r=document.getElementById("progress-bar"),u=document.getElementById("checkout-title"),o=document.getElementById("submit-order-btn"),f=document.getElementById("payment-methods"),E=document.getElementById("selected-payment-method"),S=document.getElementById("payment-instructions"),e=document.getElementById("checkout-error"),l=document.getElementById("use-geolocation-btn"),T=document.getElementById("address");let v=null;const L=()=>{if(!navigator.geolocation){e.textContent="La géolocalisation n'est pas supportée par votre navigateur.",e.classList.remove("hidden");return}l.disabled=!0,l.classList.add("animate-pulse");const m={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation.getCurrentPosition(async t=>{const{latitude:n,longitude:c}=t.coords;try{const d=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${n}&lon=${c}`)).json();if(d&&d.display_name)T.value=d.display_name;else throw new Error("Adresse non trouvée.")}catch{e.textContent="Impossible de convertir les coordonnées en adresse.",e.classList.remove("hidden")}finally{l.disabled=!1,l.classList.remove("animate-pulse")}},t=>{let n="Erreur de géolocalisation.";t.code===t.PERMISSION_DENIED&&(n="Vous avez refusé la permission d'accès à la localisation."),t.code===t.POSITION_UNAVAILABLE&&(n="Votre position n'est pas disponible."),t.code===t.TIMEOUT&&(n="Le service de localisation a mis trop de temps à répondre."),e.textContent=n,e.classList.remove("hidden"),l.disabled=!1,l.classList.remove("animate-pulse")},m)},I=async()=>{var c,p;e.classList.add("hidden");const m=s.elements.name.value.trim(),t=s.elements.phone.value.trim(),n=s.elements.address.value.trim();if(!m||!t||!n){e.textContent="Veuillez remplir tous les champs de livraison requis.",e.classList.remove("hidden");return}a.disabled=!0,a.textContent="Enregistrement...";try{const C=JSON.parse(((c=document.querySelector(".zflex-fragment-data"))==null?void 0:c.textContent)||"{}").storeId;if(!C)throw new Error("Erreur de configuration : ID du store manquant. Veuillez rafraîchir la page.");const q={name:m,phone:t,address:n,notes:s.elements.notes.value.trim()},w=i.reduce((k,B)=>k+B.price.amount*B.quantity,0),M={customer:q,items:i,total:w,currency:((p=i[0])==null?void 0:p.price.currency)||"EUR"},g=await z(M,C);if(!g.success||!g.orderId)throw v=null,new Error(g.error||"La création de la pré-commande a échoué.");v=g.orderId,localStorage.setItem("zflex_prospectId",g.prospectId),y.classList.add("hidden"),h.classList.remove("hidden"),r.style.width="60%",u.textContent="Étape 2: Paiement"}catch(d){e.textContent=d.message||"Une erreur est survenue.",e.classList.remove("hidden"),a.disabled=!1,a.textContent="Continuer vers le paiement"}},b=m=>{const t=m.target.closest(".payment-method-btn");if(!t)return;document.querySelectorAll(".payment-method-btn").forEach(c=>c.classList.remove("border-primary","ring-2","ring-offset-2")),t.classList.add("border-primary","ring-2","ring-offset-2");const n=t.dataset.method;E.value=n,S.innerHTML=`<p>Vous avez choisi <strong>${n}</strong>. Vous recevrez une notification sur le numéro de téléphone fourni pour valider la transaction.</p>`},x=async m=>{var c;if(m.preventDefault(),e.classList.add("hidden"),!v){console.error("[Checkout] Tentative de paiement sans ID de commande valide. La pré-commande a dû échouer."),e.textContent="Erreur critique : impossible de trouver la pré-commande. Veuillez rafraîchir la page et réessayer.",e.classList.remove("hidden"),o.disabled=!1;return}const t=E.value,n=s.elements.payment_phone.value;if(!t||!n||n.length<9){e.textContent="Veuillez choisir une méthode de paiement et entrer un numéro valide.",e.classList.remove("hidden");return}r.style.width="90%",o.disabled=!0,o.querySelector(".btn-text").textContent="Veuillez valider sur votre téléphone...",o.querySelector(".btn-spinner").classList.remove("hidden");try{const d=JSON.parse(((c=document.querySelector(".zflex-fragment-data"))==null?void 0:c.textContent)||"{}").storeId;if(!d)throw new Error("Erreur de configuration : ID du store manquant. Veuillez rafraîchir la page.");await P(v,d,t,n),o.querySelector(".btn-text").textContent="Paiement initié ! Redirection...",setTimeout(()=>{$(),A.navigateTo(`/order-success/?id=${encodeURIComponent(v)}`)},4e3)}catch(p){e.textContent=p.message||"Le lancement du paiement a échoué.",e.classList.remove("hidden"),r.style.width="60%",o.disabled=!1,o.querySelector(".btn-text").textContent="Confirmer et Payer",o.querySelector(".btn-spinner").classList.add("hidden")}};return a.addEventListener("click",I),f.addEventListener("click",b),l.addEventListener("click",L),s.addEventListener("submit",x),console.log("[Checkout] Module V4.4 (Ultra-Robuste) initialisé."),{destroy:()=>{a.removeEventListener("click",I),f.removeEventListener("click",b),l.removeEventListener("click",L),s.removeEventListener("submit",x),console.log("[Checkout] Module détruit.")}}}export{H as initCheckout};
